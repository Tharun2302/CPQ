<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Microsoft Auth Callback</title>
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; margin: 0; background: #f8fafc; color: #111827; }
      .center { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
      .card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); width: 360px; text-align: center; }
      .spinner { width: 48px; height: 48px; border: 4px solid #e5e7eb; border-top-color: #2563eb; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px; }
      @keyframes spin { to { transform: rotate(360deg); } }
      .ok { color: #065f46; }
      .err { color: #b91c1c; }
    </style>
  </head>
  <body>
    <div class="center">
      <div class="card">
        <div class="spinner"></div>
        <h3>Completing Microsoft sign-inâ€¦</h3>
        <p id="status">Please wait.</p>
      </div>
    </div>

    <script>
      (function () {
        try {
          const params = new URLSearchParams(window.location.search);
          const code = params.get('code');
          const error = params.get('error');

          const post = (data) => {
            // Post only to the opener on the same origin we came from (the SPA)
            try { window.opener && window.opener.postMessage(data, window.location.origin); } catch (e) {}
          };

          if (error) {
            document.getElementById('status').textContent = 'Authentication failed.';
            post({ type: 'MICROSOFT_AUTH_ERROR', error });
            // Close after a short delay
            setTimeout(() => window.close(), 300);
            return;
          }

          if (code) {
            // NOTE: In a real app, the opener should exchange the code with the backend.
            // For this demo flow, we simulate a Microsoft user like the React page does.
            const mockUser = {
              id: 'microsoft_' + Date.now(),
              name: 'Microsoft User',
              email: 'user@microsoft.com',
              accessToken: 'mock_access_token_' + Date.now()
            };
            document.getElementById('status').textContent = 'Authentication successful.';
            post({ type: 'MICROSOFT_AUTH_SUCCESS', user: mockUser });
            setTimeout(() => window.close(), 300);
            return;
          }

          document.getElementById('status').textContent = 'Missing authorization response.';
          post({ type: 'MICROSOFT_AUTH_ERROR', error: 'missing_response' });
          setTimeout(() => window.close(), 600);
        } catch (e) {
          try { post({ type: 'MICROSOFT_AUTH_ERROR', error: 'callback_exception' }); } catch (_) {}
          setTimeout(() => window.close(), 600);
        }
      })();
    </script>
  </body>
  </html>


